apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: users
spec:
  replicas: 1
  template:
    metadata:
      labels:
        service: users-service
        target_service: users-service
        targetService: users-service
        app: users
    spec:
      containers:
      - name: users-svc
        image: {{ .Values.image }}
        ports:
          - containerPort: 8080
{{ if .Values.useProxy }}
      - name: kibbegcpnextproxy
        command:
        - /usr/local/bin/envoy
        - -l
        - debug
        - -c
        - /etc/envoy/envoy-esp.conf
        env:
        - name: target_service
          value: users
        - name: TARGET_SERVICE
          value: users
        - name: targetService
          value: users
        image: gcr.io/istio-testing/proxy:gcpnext
        ports:
        - containerPort: 9090
          name: kibbegcpnextproxyport
          protocol: TCP
        volumeMounts:
        - mountPath: /downward
          name: downwardapi
        - mountPath: /etc/envoy
          name: envoy-config
          readOnly: true
      volumes:
      - configMap:
          name: users-proxy-configmap-ingress
        name: envoy-config
      - downwardAPI:
          items:
          - fieldRef:
              apiVersion: v1
              fieldPath: metadata.labels
            path: labels
          - fieldRef:
              apiVersion: v1
              fieldPath: metadata.annotations
            path: annotations
        name: downwardapi
{{ end }}
